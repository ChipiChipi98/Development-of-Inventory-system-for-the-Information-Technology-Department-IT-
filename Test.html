<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบทะเบียนเบิกวัสดุ IT</title>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600;700&display=swap');

        :root {
            --primary-color: #007bff;
            --secondary-color: #f8f9fa;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --dark-color: #343a40;
            --light-color: #ffffff;
            --border-radius: 8px;
            --font-family: 'Kanit', sans-serif;
            --navbar-height: 60px; 
            --top-nav-height: 50px; 
        }

        body {
            font-family: var(--font-family);
            margin: 0;
            padding: 0;
            background-color: #f4f7f6;
            color: var(--dark-color);
        }

        /* --- Navbar (Top Bar) Style --- */
        #navbar {
            background-color: var(--primary-color);
            color: var(--light-color);
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: var(--navbar-height);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            box-sizing: border-box;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            text-decoration: none;
            color: var(--light-color);
            transition: all 0.3s ease;
        }

        /* User Profile/Logout Button */
        #user-profile {
            cursor: pointer;
            width: 40px;
            height: 40px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            transition: background-color 0.2s;
        }

        #user-profile:hover {
            background-color: rgba(255, 255, 255, 0.4);
        }

        /* --- Top Navigation Bar (Tab Bar) Style --- */
        #top-nav {
            background-color: #0056b3; 
            position: fixed;
            top: var(--navbar-height);
            left: 0;
            width: 100%;
            height: var(--top-nav-height);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 990;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .top-nav-item {
            flex-grow: 1;
            text-align: center;
            padding: 10px 5px;
            color: var(--light-color);
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            transition: background-color 0.2s;
            cursor: pointer;
            white-space: nowrap;
        }

        .top-nav-item.active {
            background-color: var(--primary-color);
            font-weight: 700;
        }

        .top-nav-item:hover:not(.active) {
            background-color: rgba(255, 255, 255, 0.1);
        }


        /* --- Main Content Area --- */
        #main {
            padding-top: calc(var(--navbar-height) + var(--top-nav-height) + 20px);
            padding-bottom: 20px;
            padding-left: 20px;
            padding-right: 20px;
            min-height: calc(100vh - var(--navbar-height) - var(--top-nav-height));
            transition: margin-left 0.3s;
        }

        /* --- Login/Modal Styles --- */
        #login-page, #loading-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #f4f7f6;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .login-container {
            background: var(--light-color);
            padding: 40px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .login-container h1 {
            color: var(--dark-color);
            margin-bottom: 5px;
            font-weight: 600;
        }

        .login-container p {
            color: #6c757d;
            margin-bottom: 25px;
            font-size: 0.9rem;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        
        /* New: Grid layout for side-by-side inputs on the form */
        .form-row {
            display: flex;
            gap: 20px;
        }
        .form-row .form-group {
            flex: 1;
        }
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 0;
            }
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ced4da;
            border-radius: var(--border-radius);
            box-sizing: border-box;
            font-size: 1rem;
        }

        /* --- General Button Styles --- */
        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s, transform 0.1s;
            font-family: var(--font-family);
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: var(--light-color);
            width: 100%;
            padding: 12px;
        }

        .btn-primary:hover {
            background-color: #0056b3;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: var(--light-color);
        }

        .btn-danger:hover {
            background-color: #bd2130;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: var(--light-color);
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }
        
        .btn-success {
            background-color: var(--success-color);
            color: var(--light-color);
            font-size: 0.9rem;
        }
        
        .btn-success:hover {
            background-color: #1e7e34;
        }
        
        .btn-icon-danger {
            background-color: var(--danger-color);
            color: var(--light-color);
            padding: 5px 8px;
            font-size: 0.8rem;
            line-height: 1;
        }

        /* --- Content Card and Table Styling --- */
        .content-card {
            background-color: var(--light-color);
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        .content-card h2 {
            font-size: 1.5rem;
            margin-top: 0;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        
        .content-card h3 {
            font-size: 1.2rem;
            margin-top: 30px;
            color: var(--primary-color);
        }


        .table-responsive {
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.95rem;
        }

        .data-table th, .data-table td {
            border: 1px solid #dee2e6;
            padding: 8px;
            text-align: center; 
            vertical-align: middle;
        }

        .data-table th {
            background-color: var(--secondary-color);
            color: var(--dark-color);
            font-weight: 600;
            white-space: nowrap;
        }

        .data-table .align-left {
            text-align: left;
        }
        
        /* Input and Button for Add Item Row in Form */
        #addItemRow {
            display: flex;
            gap: 10px;
            align-items: flex-end;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px dashed #ced4da;
        }

        #addItemRow input[type="number"],
        #addItemRow input[type="text"] {
            padding: 8px;
            font-size: 0.9rem;
        }
        
        #searchItemInput {
            flex-grow: 2;
        }
        #itemQuantityInput {
            width: 100px;
            flex-grow: 1;
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            /* ... (keep existing media queries) */
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            #addItemRow {
                flex-wrap: wrap;
            }
            #searchItemInput {
                flex-basis: 100%;
            }
            #itemQuantityInput {
                flex-basis: 50%;
            }
            #addItemRow button {
                flex-basis: 40%;
            }
        }
    </style>
</head>
<body>

    <!-- Loading Page -->
    <div id="loading-page">
        <div class="login-container">
            <i class="fas fa-spinner fa-spin fa-3x" style="color: var(--primary-color);"></i>
            <p style="margin-top: 20px;">กำลังโหลดระบบ...</p>
        </div>
    </div>

    <!-- Login Page -->
    <div id="login-page" style="display: none;">
        <div class="login-container">
            <i class="fas fa-user-lock fa-3x" style="color: var(--primary-color); margin-bottom: 15px;"></i>
            <h1>เข้าสู่ระบบ</h1>
            <p>Chief Innovation Architect ยินดีต้อนรับ</p>
            <form id="loginForm">
                <div class="form-group">
                    <label for="usernameInput">ชื่อผู้ใช้</label>
                    <input type="text" id="usernameInput" placeholder="กรุณากรอกชื่อผู้ใช้" required>
                </div>
                <div class="form-group">
                    <label for="passwordInput">รหัสผ่าน</label>
                    <input type="password" id="passwordInput" placeholder="กรุณากรอกรหัสผ่าน" required>
                </div>
                <button type="submit" class="btn btn-primary">ยืนยัน</button>
            </form>
            <div id="loginMessage" style="color: var(--danger-color); margin-top: 15px;"></div>
        </div>
    </div>

    <!-- Main Application Content -->
    <div id="app-container" style="display: none;">

        <!-- Top Navbar -->
        <div id="navbar">
            <div class="logo">
                <i class="fas fa-tools"></i> ระบบทะเบียนเบิกวัสดุ IT
            </div>
            <!-- Profile Icon remains on the right to trigger Logout Modal -->
            <div id="user-profile">
                <i class="fas fa-user"></i>
            </div>
        </div>
        
        <!-- Top Navigation Bar (Tab Bar) -->
        <div id="top-nav">
            <div class="top-nav-item active" data-page="form-เบิก">ฟอร์มเบิก</div>
            <div class="top-nav-item" data-page="stock">สต็อกคงเหลือ</div>
            <div class="top-nav-item" data-page="history">ประวัติการเบิก</div>
            <div class="top-nav-item" data-page="edit-stock">เพิ่ม/ปรับสต็อก</div>
        </div>

        <!-- Logout Confirmation Modal -->
        <div id="logoutModal" class="modal">
            <div class="modal-content">
                <h3>ยืนยันการออกจากระบบ</h3>
                <p>คุณต้องการออกจากระบบใช่หรือไม่?</p>
                <div class="modal-buttons">
                    <button class="btn btn-danger" id="confirmLogoutBtn">ใช่, ออกจากระบบ</button>
                    <button class="btn btn-secondary" id="cancelLogoutBtn">ไม่</button>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div id="main">
            <!-- Pages will be rendered here -->
            <div id="form-เบิก-page" class="page">
                <div class="content-card">
                    <h2>ระบบทะเบียนเบิกวัสดุอุปกรณ์แผนกเทคโนโลยีสารสนเทศ</h2>
                    <p style="font-weight: 600; font-size: 1.2rem; color: #343a40;">ฟอร์มบันทึกการเบิก</p>
                    <form id="checkoutForm">
                        <!-- Form Row 1: Borrower Info -->
                        <div class="form-row">
                            <div class="form-group">
                                <label for="borrowerName">ชื่อผู้เบิก</label>
                                <input type="text" id="borrowerName" placeholder="ชื่อ-นามสกุล ผู้เบิก" required>
                            </div>
                            <div class="form-group">
                                <label for="borrowerId">รหัสผู้เบิก (รหัสประจำตัวนศ. 11 หลัก):</label>
                                <input type="text" id="borrowerId" placeholder="เช่น 68219010001" maxlength="11" required>
                                <small id="borrowerIdError" style="color: var(--danger-color); display: none;">กรุณากรอกรหัสประจำตัว 11 หลักให้ถูกต้องตามรูปแบบ</small>
                            </div>
                        </div>

                        <!-- Form Row 2: Date/Time/Type -->
                        <div class="form-row">
                            <div class="form-group">
                                <label for="checkoutDate">วันที่เบิก:</label>
                                <input type="date" id="checkoutDate" required>
                            </div>
                            <div class="form-group">
                                <label for="checkoutTime">เวลาที่เบิก:</label>
                                <input type="time" id="checkoutTime" required>
                            </div>
                        </div>
                        
                        <!-- Form Row 3: Type and Return Date -->
                        <div class="form-row">
                            <div class="form-group">
                                <label for="checkoutTypeInput">ประเภทการทำรายการ:</label>
                                <select id="checkoutTypeInput" required onchange="toggleReturnDate()">
                                    <option value="เบิก" selected>เบิก (ตัดจากสต็อกถาวร)</option>
                                    <option value="ยืม">ยืม (คืนภายหลัง)</option>
                                </select>
                            </div>
                            <div class="form-group" id="returnDateGroup">
                                <label for="returnDate">กำหนดคืน (ไม่จำเป็นต้องกรอก):</label>
                                <input type="date" id="returnDate">
                            </div>
                        </div>
                        
                        <!-- Item Adding Section -->
                        <h3 style="margin-top: 30px; border-bottom: none; padding-bottom: 0;">ค้นหาและเพิ่มอุปกรณ์เข้าตะกร้า</h3>
                        <div id="addItemRow">
                            <input type="text" id="searchItemInput" placeholder="พิมพ์รหัส (M-001) หรือชื่ออุปกรณ์ (เมาส์)" list="stockDatalist">
                            <datalist id="stockDatalist">
                                <!-- Options will be populated by JS -->
                            </datalist>
                            <input type="number" id="itemQuantityInput" placeholder="จำนวน" min="1" value="1">
                            <button type="button" class="btn btn-success" onclick="addItemToCheckoutList()">เพิ่มรายการ</button>
                        </div>
                        
                        <!-- Item List Table -->
                        <h3 style="margin-top: 0; border-bottom: none; padding-bottom: 0;">รายการอุปกรณ์ที่รอเบิก (<span id="itemCount">0</span> รายการ)</h3>
                        <div class="table-responsive">
                            <table id="checkoutTable" class="data-table">
                                <thead>
                                    <tr>
                                        <th style="width: 10%;">รหัส</th>
                                        <th class="align-left">อุปกรณ์</th>
                                        <th style="width: 15%;">จำนวน</th>
                                        <th style="width: 10%;">ลบ</th>
                                    </tr>
                                </thead>
                                <tbody id="checkoutTableBody">
                                    <!-- Items will be added here -->
                                </tbody>
                            </table>
                        </div>
                        <div id="checkoutMessage" style="color: var(--danger-color); margin-top: 15px;"></div>

                        <button type="submit" class="btn btn-primary" style="margin-top: 20px;">บันทึกการเบิกทั้งหมด</button>
                    </form>
                </div>
            </div>

            <!-- STOCK PAGE (KEPT AS IS) -->
            <div id="stock-page" class="page" style="display: none;">
                <div class="content-card">
                    <h2>สต็อกคงเหลือ</h2>
                    <input type="text" id="stock-search" placeholder="ค้นหาด้วยรหัสหรือชื่ออุปกรณ์..." onkeyup="renderStockTable()">
                    <div id="stock-list-container" class="table-responsive">
                        <!-- Stock Table Renders Here -->
                    </div>
                    <div style="margin-top: 20px; font-size: 0.9rem; color: #6c757d;">
                        *ข้อมูลสต็อกถูกจัดเก็บใน Local Storage ของเบราว์เซอร์นี้
                    </div>
                </div>
            </div>

            <!-- HISTORY PAGE (KEPT AS IS) -->
            <div id="history-page" class="page" style="display: none;">
                <div class="content-card">
                    <h2>ประวัติการเบิก</h2>
                    <div id="history-list-container" class="table-responsive">
                        <table id="history-table" class="data-table">
                            <thead>
                                <tr>
                                    <th>วันที่</th>
                                    <th>รหัสผู้เบิก</th>
                                    <th class="align-left">ชื่อผู้เบิก</th>
                                    <th class="align-left">รายการอุปกรณ์</th>
                                    <th>รวมจำนวน</th>
                                    <th>ประเภท/สถานะ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- History Logs Renders Here -->
                            </tbody>
                        </table>
                    </div>
                    <div style="margin-top: 20px; font-size: 0.9rem; color: #6c757d;">
                        *ข้อมูลประวัติถูกจัดเก็บใน Local Storage ของเบราว์เซอร์นี้
                    </div>
                </div>
            </div>

            <!-- EDIT STOCK PAGE (KEPT AS IS) -->
            <div id="edit-stock-page" class="page" style="display: none;">
                <div class="content-card">
                    <h2>เพิ่ม/แก้ไขสต็อก</h2>
                    <form id="editStockForm">
                        <div class="form-group">
                            <label for="editCode">รหัสอุปกรณ์ (เช่น C-001)</label>
                            <input type="text" id="editCode" placeholder="รหัสอุปกรณ์" required>
                        </div>
                        <div class="form-group">
                            <label for="editName">ชื่ออุปกรณ์</label>
                            <input type="text" id="editName" placeholder="ชื่ออุปกรณ์ (เช่น เมาส์, คีย์บอร์ด)" required>
                        </div>
                        <div class="form-group">
                            <label for="editType">ประเภท</label>
                            <input type="text" id="editType" placeholder="ประเภท (เช่น มัลติมีเดีย, อุปกรณ์ต่อพ่วง)" required>
                        </div>
                        <div class="form-group">
                            <label for="editUnit">หน่วยนับ</label>
                            <input type="text" id="editUnit" placeholder="หน่วยนับ (เช่น ตัว, เส้น, เครื่อง)" required>
                        </div>
                        <div class="form-group">
                            <label for="editQuantity">จำนวนคงเหลือปัจจุบัน (เริ่มต้น)</label>
                            <input type="number" id="editQuantity" placeholder="จำนวนคงเหลือ" min="0" required>
                        </div>
                        <button type="submit" class="btn btn-primary">บันทึก/อัปเดตสต็อก</button>
                    </form>
                    
                    <h3 style="margin-top: 30px;">รายการสต็อกทั้งหมด (สำหรับลบ)</h3>
                    <div id="all-stock-list" class="table-responsive">
                        <!-- All Stock List for Deletion Renders Here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Hardcode Login Credentials ---
        const VALID_USERNAME = 'admin';
        const VALID_PASSWORD = 'admin1234';

        // --- Global Constants for UI/Theming ---
        const PRIMARY_COLOR = '#007bff';
        const SUCCESS_COLOR = '#28a745';
        const DANGER_COLOR = '#dc3545';
        const BORDER_RADIUS = '8px';
        
        // --- Core Data Management (Using LocalStorage) ---
        function getStockData() {
            return JSON.parse(localStorage.getItem('itStock') || '[]');
        }

        function saveStockData(stock) {
            localStorage.setItem('itStock', JSON.stringify(stock));
        }

        function getHistoryLogs() {
            return JSON.parse(localStorage.getItem('itHistory') || '[]');
        }

        function saveHistoryLogs(logs) {
            localStorage.setItem('itHistory', JSON.stringify(logs));
        }
        
        let checkoutItems = [];

        // --- UI State Management ---
        let currentPage = 'form-เบิก';

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.style.display = 'none';
            });
            document.getElementById(pageId + '-page').style.display = 'block';
            currentPage = pageId;
            updateActiveNav();
            // Specific render calls for pages
            if (pageId === 'form-เบิก') {
                updateDatalistOptions();
                renderCheckoutTable(); // Ensure table is rendered on page load
            } else if (pageId === 'stock') {
                renderStockTable();
            } else if (pageId === 'history') {
                renderHistoryLogs();
            } else if (pageId === 'edit-stock') {
                renderAllStockForDeletion();
            }
        }

        function updateActiveNav() {
            document.querySelectorAll('#top-nav .top-nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('data-page') === currentPage) {
                    item.classList.add('active');
                }
            });
        }

        function navigateTo(pageId) {
            showPage(pageId);
        }

        // --- Authentication & Initialization ---
        function checkLogin() {
            const loggedIn = localStorage.getItem('isLoggedIn') === 'true';
            document.getElementById('loading-page').style.display = 'none';
            if (loggedIn) {
                document.getElementById('app-container').style.display = 'block';
                document.getElementById('login-page').style.display = 'none';
                showPage('form-เบิก'); // Default page after login
            } else {
                document.getElementById('app-container').style.display = 'none';
                document.getElementById('login-page').style.display = 'flex';
            }
        }

        function loginUser(username, password) {
            if (username === VALID_USERNAME && password === VALID_PASSWORD) {
                localStorage.setItem('isLoggedIn', 'true');
                checkLogin();
                alertMessage('เข้าสู่ระบบสำเร็จ', 'success');
            } else {
                document.getElementById('loginMessage').textContent = 'ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง';
            }
        }

        function logoutUser() {
            localStorage.removeItem('isLoggedIn');
            checkLogin();
            alertMessage('ออกจากระบบเรียบร้อยแล้ว', 'success');
        }

        function alertMessage(message, type = 'info') {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background-color: rgba(0, 0, 0, 0.5); display: flex; justify-content: center;
                align-items: center; z-index: 3000; font-family: 'Kanit', sans-serif;
            `;
            const content = document.createElement('div');
            content.style.cssText = `
                background-color: white; padding: 25px; border-radius: ${BORDER_RADIUS};
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); width: 80%; max-width: 300px;
                text-align: center;
            `;
            const color = type === 'success' ? SUCCESS_COLOR : type === 'error' ? DANGER_COLOR : PRIMARY_COLOR;
            content.innerHTML = `
                <div style="color: ${color}; font-size: 1.2rem; font-weight: 600; margin-bottom: 15px;">
                    ${message}
                </div>
                <button class="btn" style="background-color: ${color}; color: white; width: 100%;" onclick="this.closest('div[style*=\\'fixed\\']').remove()">ตกลง</button>
            `;
            modal.appendChild(content);
            document.body.appendChild(modal);
        }

        function confirmAction(message, callback) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background-color: rgba(0, 0, 0, 0.5); display: flex; justify-content: center;
                align-items: center; z-index: 4000; font-family: 'Kanit', sans-serif;
            `;
            const content = document.createElement('div');
            content.style.cssText = `
                background-color: white; padding: 25px; border-radius: ${BORDER_RADIUS};
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); width: 80%; max-width: 350px;
                text-align: center;
            `;

            content.innerHTML = `
                <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 20px;">
                    ${message}
                </div>
                <div style="display: flex; justify-content: space-around;">
                    <button class="btn btn-danger" id="modalConfirmBtn" style="width: 45%;">ยืนยัน</button>
                    <button class="btn btn-secondary" id="modalCancelBtn" style="width: 45%; background-color: #6c757d;">ยกเลิก</button>
                </div>
            `;
            modal.appendChild(content);
            document.body.appendChild(modal);

            document.getElementById('modalConfirmBtn').onclick = () => {
                modal.remove();
                callback(true);
            };
            document.getElementById('modalCancelBtn').onclick = () => {
                modal.remove();
                callback(false);
            };
        }

        // --- Form Utility Functions ---
        function validateBorrowerId(id) {
            if (!/^\d{11}$/.test(id)) return false;
            const part1 = parseInt(id.substring(0, 2));
            const part2 = parseInt(id.substring(2, 6));
            const part3 = parseInt(id.substring(6, 11));
            return (part1 >= 60 && part1 <= 70) && (part2 >= 1000 && part2 <= 9999) && (part3 >= 10000 && part3 <= 99999);
        }

        function toggleReturnDate() {
            const type = document.getElementById('checkoutTypeInput').value;
            const returnDateGroup = document.getElementById('returnDateGroup');
            const returnDateInput = document.getElementById('returnDate');
            
            if (type === 'ยืม') {
                returnDateGroup.style.display = 'block';
                returnDateInput.setAttribute('required', 'required');
            } else {
                returnDateGroup.style.display = 'block'; // Keep visible but not required
                returnDateInput.removeAttribute('required');
                // returnDateInput.value = ''; // Do not clear the value, but it's optional
            }
        }
        
        function updateDatalistOptions() {
            const stock = getStockData();
            const datalist = document.getElementById('stockDatalist');
            datalist.innerHTML = '';
            stock.forEach(item => {
                const option = document.createElement('option');
                option.value = `${item.code} - ${item.name} (คงเหลือ: ${item.quantity} ${item.unit})`;
                datalist.appendChild(option);
            });
        }
        
        // --- Checkout Item List Management (New Logic) ---
        
        function addItemToCheckoutList() {
            const searchInput = document.getElementById('searchItemInput');
            const qtyInput = document.getElementById('itemQuantityInput');
            const searchVal = searchInput.value.trim();
            const quantity = parseInt(qtyInput.value, 10);
            const stock = getStockData();
            
            if (!searchVal || isNaN(quantity) || quantity <= 0) {
                alertMessage('กรุณากรอกชื่อ/รหัสอุปกรณ์และจำนวนที่ถูกต้อง', 'error');
                return;
            }

            // 1. Find the item in stock (by code or name)
            let item = stock.find(i => 
                searchVal.includes(i.code) || searchVal.includes(i.name)
            );
            
            if (!item) {
                alertMessage(`ไม่พบอุปกรณ์ "${searchVal}" ในสต็อก`, 'error');
                return;
            }

            // 2. Check stock availability
            if (item.quantity < quantity) {
                alertMessage(`สต็อกไม่พอ! ${item.name} (คงเหลือ: ${item.quantity} ${item.unit})`, 'error');
                return;
            }
            
            // 3. Check if item already exists in the checkout list
            const existingItemIndex = checkoutItems.findIndex(i => i.code === item.code);
            
            if (existingItemIndex > -1) {
                // If exists, update quantity
                const newQty = checkoutItems[existingItemIndex].quantity + quantity;
                if (item.quantity < newQty) {
                    alertMessage(`สต็อกไม่พอหากเพิ่มอีก ${quantity} หน่วย!`, 'error');
                    return;
                }
                checkoutItems[existingItemIndex].quantity = newQty;
            } else {
                // If new, add it
                checkoutItems.push({
                    code: item.code,
                    name: item.name,
                    quantity: quantity
                });
            }

            // 4. Reset inputs and render table
            searchInput.value = '';
            qtyInput.value = 1;
            renderCheckoutTable();
        }

        function removeItemFromCheckoutList(code) {
            checkoutItems = checkoutItems.filter(item => item.code !== code);
            renderCheckoutTable();
        }
        
        function renderCheckoutTable() {
            const tbody = document.getElementById('checkoutTableBody');
            const itemCountSpan = document.getElementById('itemCount');
            tbody.innerHTML = '';
            
            if (checkoutItems.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" style="text-align: center; color: #6c757d;">กรุณาเพิ่มอุปกรณ์ที่ต้องการเบิก/ยืม</td></tr>`;
                itemCountSpan.textContent = 0;
                return;
            }
            
            checkoutItems.forEach(item => {
                const stock = getStockData();
                const stockItem = stock.find(i => i.code === item.code);
                const unit = stockItem ? stockItem.unit : 'หน่วย';

                tbody.innerHTML += `
                    <tr>
                        <td>${item.code}</td>
                        <td class="align-left">${item.name}</td>
                        <td>${item.quantity} ${unit}</td>
                        <td>
                            <button type="button" class="btn btn-icon-danger" onclick="removeItemFromCheckoutList('${item.code}')">
                                <i class="fas fa-times"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            itemCountSpan.textContent = checkoutItems.length;
        }


        // --- Main Checkout Function ---
        function processCheckout(event) {
            event.preventDefault();

            if (checkoutItems.length === 0) {
                alertMessage('กรุณาเพิ่มรายการอุปกรณ์ที่ต้องการเบิก/ยืมลงในตะกร้าก่อน', 'error');
                return;
            }

            const borrowerIdInput = document.getElementById('borrowerId');
            const borrowerId = borrowerIdInput.value;
            const borrowerName = document.getElementById('borrowerName').value;
            const checkoutDate = document.getElementById('checkoutDate').value;
            const checkoutTime = document.getElementById('checkoutTime').value;
            const checkoutType = document.getElementById('checkoutTypeInput').value;
            const returnDate = document.getElementById('returnDate').value;

            // 1. Validate Borrower ID
            if (!validateBorrowerId(borrowerId)) {
                document.getElementById('borrowerIdError').style.display = 'block';
                return;
            } else {
                document.getElementById('borrowerIdError').style.display = 'none';
            }

            // 2. Update Stock (The item list is already validated for existence/stock during addItem)
            let stock = getStockData();
            let totalQuantity = 0;

            for (const item of checkoutItems) {
                const itemIndex = stock.findIndex(i => i.code === item.code);

                if (itemIndex > -1) {
                    // This subtracts the quantity from the stock
                    stock[itemIndex].quantity -= item.quantity;
                    totalQuantity += item.quantity;
                } else {
                    // Should not happen if addItemToCheckoutList logic is correct, but added for safety
                    alertMessage(`ข้อผิดพลาด: ไม่พบอุปกรณ์รหัส ${item.code} ในสต็อกขณะบันทึก!`, 'error');
                    return;
                }
            }

            // 3. Save Stock and Log History
            saveStockData(stock);

            const historyLogs = getHistoryLogs();
            const newLog = {
                date: checkoutDate,
                time: checkoutTime,
                borrowerId: borrowerId,
                borrowerName: borrowerName,
                // Log only the necessary details for history
                items: checkoutItems.map(i => ({ name: i.name, quantity: i.quantity })),
                totalQuantity: totalQuantity,
                type: checkoutType,
                returnDate: checkoutType === 'ยืม' ? returnDate : null,
                timestamp: Date.now()
            };
            historyLogs.unshift(newLog); // Add to the beginning
            saveHistoryLogs(historyLogs);

            alertMessage('บันทึกการเบิกสำเร็จ! สต็อกถูกอัปเดตแล้ว', 'success');
            
            // 4. Reset Form and Checkout State
            document.getElementById('checkoutForm').reset();
            checkoutItems = []; 
            renderCheckoutTable();
            toggleReturnDate(); 
        }

        // --- Stock Page Functions (Keep unchanged) ---
        function renderStockTable() {
            const stock = getStockData();
            const search = document.getElementById('stock-search').value.toLowerCase();

            const filteredStock = stock.filter(item =>
                item.code.toLowerCase().includes(search) || item.name.toLowerCase().includes(search)
            );

            const container = document.getElementById('stock-list-container');
            if (filteredStock.length === 0) {
                container.innerHTML = `<p style="text-align: center; margin-top: 20px;">ไม่พบอุปกรณ์ที่ค้นหา หรือยังไม่มีข้อมูลสต็อก</p>`;
                return;
            }

            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>รหัส</th>
                            <th class="align-left">อุปกรณ์</th>
                            <th>ประเภท</th>
                            <th>สต็อก</th>
                            <th>หน่วยย่อย</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            filteredStock.forEach(item => {
                const qtyClass = item.quantity <= 5 ? 'stock-low' : 'stock-ok';
                html += `
                    <tr>
                        <td>${item.code}</td>
                        <td class="align-left">${item.name}</td>
                        <td>${item.type}</td>
                        <td class="${qtyClass}">${item.quantity}</td>
                        <td>${item.unit}</td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;
            container.innerHTML = html;
        }

        // --- History Page Functions (Keep unchanged) ---
        function renderHistoryLogs() {
            const historyLogs = getHistoryLogs();
            const tbody = document.getElementById('history-table').querySelector('tbody');
            tbody.innerHTML = '';

            if (historyLogs.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align: center;">ยังไม่มีประวัติการเบิก</td></tr>`;
                return;
            }

            historyLogs.forEach(log => {
                const formattedItems = log.items.map(i => {
                    const stockItem = getStockData().find(s => s.name === i.name);
                    const unit = stockItem ? stockItem.unit : 'หน่วย';
                    return `${i.name} [${i.quantity} ${unit}]`;
                }).join(', ');

                let statusText = log.type;
                if (log.type === 'ยืม' && log.returnDate) {
                    statusText = `ยืม (คืน: ${log.returnDate})`;
                }

                tbody.innerHTML += `
                    <tr>
                        <td>${log.date}<br><small>${log.time}</small></td>
                        <td>${log.borrowerId}</td>
                        <td class="align-left">${log.borrowerName}</td>
                        <td class="align-left">${formattedItems}</td>
                        <td>${log.totalQuantity}</td>
                        <td>${statusText}</td>
                    </tr>
                `;
            });
        }

        // --- Edit Stock Page Functions (Keep unchanged) ---
        function processEditStock(event) {
            event.preventDefault();

            const code = document.getElementById('editCode').value.toUpperCase();
            const name = document.getElementById('editName').value;
            const type = document.getElementById('editType').value;
            const unit = document.getElementById('editUnit').value;
            const quantity = parseInt(document.getElementById('editQuantity').value, 10);

            if (isNaN(quantity) || quantity < 0) {
                alertMessage('จำนวนคงเหลือต้องเป็นตัวเลขที่ไม่เป็นลบ', 'error');
                return;
            }

            let stock = getStockData();
            const itemIndex = stock.findIndex(i => i.code === code);

            if (itemIndex > -1) {
                // Update existing item
                stock[itemIndex].name = name;
                stock[itemIndex].type = type;
                stock[itemIndex].unit = unit;
                stock[itemIndex].quantity = quantity;
                alertMessage(`อัปเดตสต็อก [${code}] สำเร็จ`, 'success');
            } else {
                // Add new item
                stock.push({
                    code: code,
                    name: name,
                    type: type,
                    unit: unit,
                    quantity: quantity
                });
                alertMessage(`เพิ่มอุปกรณ์ใหม่ [${code}] สำเร็จ`, 'success');
            }

            saveStockData(stock);
            document.getElementById('editStockForm').reset();
            renderAllStockForDeletion();
        }

        function renderAllStockForDeletion() {
            const stock = getStockData();
            const container = document.getElementById('all-stock-list');

            if (stock.length === 0) {
                container.innerHTML = `<p style="text-align: center; margin-top: 10px;">ยังไม่มีข้อมูลในสต็อก</p>`;
                return;
            }

            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>รหัส</th>
                            <th class="align-left">ชื่ออุปกรณ์</th>
                            <th>คงเหลือ</th>
                            <th>จัดการ</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            stock.forEach(item => {
                html += `
                    <tr>
                        <td>${item.code}</td>
                        <td class="align-left">${item.name}</td>
                        <td>${item.quantity}</td>
                        <td><button class="btn btn-danger" onclick="deleteStockItem('${item.code}')">ลบ</button></td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;
            container.innerHTML = html;
        }

        function deleteStockItem(code) {
            confirmAction(`คุณต้องการลบอุปกรณ์ที่มีรหัส ${code} ใช่หรือไม่?`, (confirmed) => {
                if (confirmed) {
                    let stock = getStockData();
                    stock = stock.filter(item => item.code !== code);
                    saveStockData(stock);
                    renderAllStockForDeletion();
                    // If the user is on the 'form-เบิก' page, refresh the datalist
                    if (currentPage === 'form-เบิก') {
                        updateDatalistOptions();
                    }
                    alertMessage(`ลบอุปกรณ์ ${code} ออกจากสต็อกแล้ว`, 'success');
                }
            });
        }
        
        // --- Event Listeners and Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            checkLogin();

            // Set default date/time for Checkout Form
            const today = new Date();
            const dateString = today.toISOString().split('T')[0];
            const timeString = today.toTimeString().substring(0, 5);
            document.getElementById('checkoutDate').value = dateString;
            document.getElementById('checkoutTime').value = timeString;

            // Form Submissions
            document.getElementById('loginForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const username = document.getElementById('usernameInput').value;
                const password = document.getElementById('passwordInput').value;
                loginUser(username, password);
            });

            document.getElementById('checkoutForm').addEventListener('submit', processCheckout);
            document.getElementById('editStockForm').addEventListener('submit', processEditStock);
            document.getElementById('borrowerId').addEventListener('input', () => {
                document.getElementById('borrowerIdError').style.display = 'none';
            });

            // Navigation from Top Nav
            document.querySelectorAll('#top-nav .top-nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    const page = item.getAttribute('data-page');
                    if (page) {
                        navigateTo(page);
                    }
                });
            });
            
            // Logout Modal setup
            const logoutModal = document.getElementById('logoutModal');
            document.getElementById('user-profile').addEventListener('click', () => {
                logoutModal.style.display = 'flex';
            });

            document.getElementById('cancelLogoutBtn').addEventListener('click', () => {
                logoutModal.style.display = 'none';
            });
            document.getElementById('confirmLogoutBtn').addEventListener('click', () => {
                logoutModal.style.display = 'none';
                logoutUser();
            });

            // Initial state check for 'ยืม' option and datalist
            toggleReturnDate();
            updateDatalistOptions();

            // Set initial dummy data if local storage is empty
            if (getStockData().length === 0) {
                const initialStock = [
                    { code: 'C-001', name: 'กล้อง Webcam HD', type: 'มัลติมีเดีย', unit: 'ตัว', quantity: 6 },
                    { code: 'D-002', name: 'จอภาพ 24"', type: 'แสดงผล', unit: 'จอ', quantity: 8 },
                    { code: 'H-003', name: 'สาย HDMI (2M)', type: 'สายสัญญาณ', unit: 'เส้น', quantity: 30 },
                    { code: 'K-004', name: 'คีย์บอร์ด (Standard)', type: 'อุปกรณ์ต่อพ่วง', unit: 'ตัว', quantity: 10 },
                    { code: 'L-005', name: 'สาย LAN (5M)', type: 'สายสัญญาณ', unit: 'เส้น', quantity: 5 },
                    { code: 'M-006', name: 'เมาส์ (Optical)', type: 'อุปกรณ์ต่อพ่วง', unit: 'ตัว', quantity: 15 },
                    { code: 'N-007', name: 'แล็บท็อป (Standard)', type: 'คอมพิวเตอร์', unit: 'เครื่อง', quantity: 3 },
                    { code: 'P-008', name: 'ปลั๊กไฟ (5 ช่อง)', type: 'อื่นๆ', unit: 'อัน', quantity: 12 },
                ];
                saveStockData(initialStock);
            }
        });
    </script>
</body>
</html>